<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - ASIA PAYMENT</title>
    <style>
        :root {
            --primary: #0055ff;
            --secondary: #00aaff;
            --accent: #ff5500;
            --light: #ffffff;
            --dark: #212121;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --bg-gradient: linear-gradient(135deg, #0055ff, #00aaff);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            background: var(--bg-gradient);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: background 0.5s ease;
        }
        
        .container {
            width: 100%;
            max-width: 450px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
            z-index: 1;
        }
        
        .header {
            background: var(--bg-gradient);
            padding: 20px;
            text-align: center;
            color: white;
            position: relative;
        }
        
        .security-notice {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            backdrop-filter: blur(5px);
        }
        
        .header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 15px;
            border: 3px solid white;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .form-container {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 85, 255, 0.1);
        }
        
        .form-group input.error {
            border-color: var(--danger);
        }
        
        .error-text {
            color: var(--danger);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        button {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #0044cc;
        }
        
        .switch-form {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .switch-form a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        .switch-form a:hover {
            text-decoration: underline;
        }
        
        .result {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            display: none;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Popup Loading Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-popup {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            min-width: 250px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: var(--dark);
        }

        .retry-button {
            margin-top: 10px;
            background: var(--accent);
        }
        
        .retry-button:hover {
            background: #e04a00;
        }
        
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1001;
        }
        
        .connection-status.connected {
            background-color: var(--success);
            color: white;
        }
        
        .connection-status.disconnected {
            background-color: var(--danger);
            color: white;
        }
        
        .connection-status.warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid var(--primary);
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .protocol-info {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 13px;
            color: #666;
        }
        
        .protocol-info span {
            margin-left: 5px;
        }
        
        .https-badge {
            background: var(--success);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .http-badge {
            background: var(--warning);
            color: var(--dark);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .server-status {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .status-value {
            font-weight: 600;
        }
        
        .status-connected {
            color: var(--success);
        }
        
        .status-disconnected {
            color: var(--danger);
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status" style="display: none;">Status Koneksi</div>
    
    <div class="container">
        <div class="header">
            <div class="security-notice">AMAN</div>
            <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgoChegZIJ3ZMDbPsF24DjVP68tqUjY-kl2-y_TWpfJuJLt1XHPqKEfQI_oL9-cC8iA8GaALbOP7VsgmqDWsPUaTfHSHxp6e_LOGIMy3op4C8m-12nLPXgbYGIxKeKHPb4lnKzztycM5GNBK6QwYvW0omPYX9fduw8c9K6BGj_dAv9-4acxnU1ZF6en4oA/s512/logo_asia_payment.jpg" alt="Logo ASIA PAYMENT">
            <h1 id="appName">ASIA PAYMENT</h1>
            <p>Platform Pembayaran Terlengkap</p>
            
            <div class="protocol-info">
                <span id="protocolIndicator"></span>
            </div>
        </div>
        
        <div class="form-container">
            <div class="info-box">
                <strong>Info Koneksi:</strong> Halaman ini dihosting di GitHub Pages (HTTPS) dan terhubung ke server backend Anda.
            </div>
            
            <div class="server-status">
                <div class="status-item">
                    <span>Status GitHub Pages:</span>
                    <span class="status-value status-connected" id="githubStatus">Terhubung</span>
                </div>
                <div class="status-item">
                    <span>Status Server Backend:</span>
                    <span class="status-value" id="backendStatus">Memeriksa...</span>
                </div>
                <div class="status-item">
                    <span>Protokol yang digunakan:</span>
                    <span class="status-value" id="protocolStatus">Memeriksa...</span>
                </div>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="kode">Kode Reseller:</label>
                    <input type="text" id="kode" name="kode" required placeholder="Masukkan kode reseller" value="Owner">
                </div>
                
                <div class="form-group">
                    <label for="nomorhp">Nomor HP:</label>
                    <input type="text" id="nomorhp" name="nomorhp" required placeholder="Masukkan nomor HP" value="082311640444">
                    <div class="error-text" id="nomorhpError">Nomor HP hanya boleh berisi angka</div>
                </div>
                
                <button type="submit">Login</button>
            </form>
            
            <div class="switch-form">
                Belum punya akun? <a href="daftar.html">Daftar di sini</a>
            </div>
            
            <div id="result" class="result"></div>
        </div>
    </div>

    <!-- Popup Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-popup">
            <div class="loading-spinner"></div>
            <div class="loading-text">Memverifikasi login...</div>
        </div>
    </div>

    <script>
        // Variabel global untuk konfigurasi
        let firebaseDataUrl = '';
        let appName = 'ASIA PAYMENT';
        let apiBaseUrl = '';
        let isOnline = false;
        let currentProtocol = '';

        // Fungsi untuk menampilkan status koneksi
        function updateConnectionStatus(connected, message = '') {
            const statusElement = document.getElementById('connectionStatus');
            isOnline = connected;
            
            if (connected) {
                statusElement.textContent = message || 'Terhubung ke Server';
                statusElement.className = 'connection-status connected';
                statusElement.style.display = 'block';
                
                // Sembunyikan status setelah 3 detik
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            } else {
                statusElement.textContent = message || 'Tidak Terhubung ke Server';
                statusElement.className = 'connection-status disconnected';
                statusElement.style.display = 'block';
            }
        }

        // Fungsi untuk menampilkan warning koneksi
        function showWarning(message) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = message;
            statusElement.className = 'connection-status warning';
            statusElement.style.display = 'block';
            
            // Sembunyikan status setelah 5 detik
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Fungsi untuk menampilkan loading popup
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        // Fungsi untuk menyembunyikan loading popup
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Fungsi untuk menampilkan pesan error
        function showError(message, isRetryable = false) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result error';
            
            let html = `<strong>Error:</strong> ${message}`;
            
            if (isRetryable) {
                html += `<br><button class="retry-button" onclick="retryConnection()">Coba Lagi</button>`;
            }
            
            resultDiv.innerHTML = html;
        }

        // Fungsi untuk menampilkan pesan info
        function showInfo(message) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = message;
        }

        // Fungsi untuk mencoba kembali koneksi
        function retryConnection() {
            document.getElementById('result').style.display = 'none';
            initializeApp();
        }

        // Fungsi untuk menentukan base URL API
        function determineApiBaseUrl() {
            // Deteksi jika di GitHub Pages (HTTPS)
            if (window.location.hostname.includes('github.io')) {
                currentProtocol = 'https:';
                document.getElementById('protocolIndicator').innerHTML = '<span class="https-badge">HTTPS</span> GitHub Pages';
                return "https://91.99.163.28:8080";
            }
            
            // Untuk localhost, gunakan protocol yang sama dengan halaman
            currentProtocol = window.location.protocol;
            
            if (currentProtocol === 'https:') {
                document.getElementById('protocolIndicator').innerHTML = '<span class="https-badge">HTTPS</span> Aman';
                return "https://91.99.163.28:8080";
            } else {
                document.getElementById('protocolIndicator').innerHTML = '<span class="http-badge">HTTP</span> Tidak Aman';
                return "http://91.99.163.28:8080";
            }
        }

        // Fungsi untuk memeriksa koneksi ke server
        async function checkServerConnection() {
            const backendStatusElement = document.getElementById('backendStatus');
            const protocolStatusElement = document.getElementById('protocolStatus');
            
            try {
                apiBaseUrl = determineApiBaseUrl();
                protocolStatusElement.textContent = apiBaseUrl.startsWith('https') ? 'HTTPS (Aman)' : 'HTTP (Tidak Aman)';
                
                const response = await fetch(`${apiBaseUrl}/api/config`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                
                if (response.ok) {
                    backendStatusElement.textContent = 'Terhubung';
                    backendStatusElement.className = 'status-value status-connected';
                    updateConnectionStatus(true, 'Terhubung ke Server Backend');
                    return true;
                } else {
                    backendStatusElement.textContent = 'Tidak Terhubung';
                    backendStatusElement.className = 'status-value status-disconnected';
                    updateConnectionStatus(false, 'Server backend tidak merespons');
                    return false;
                }
            } catch (error) {
                console.error("Koneksi server gagal:", error);
                backendStatusElement.textContent = 'Tidak Terhubung';
                backendStatusElement.className = 'status-value status-disconnected';
                
                if (apiBaseUrl.startsWith('https')) {
                    showWarning("Server HTTPS tidak merespons. Mencoba HTTP...");
                    // Coba fallback ke HTTP
                    apiBaseUrl = "http://91.99.163.28:8080";
                    protocolStatusElement.textContent = 'HTTP (Fallback)';
                    
                    // Coba lagi dengan HTTP
                    try {
                        const httpResponse = await fetch(`${apiBaseUrl}/api/config`, {
                            method: 'GET',
                            signal: AbortSignal.timeout(5000)
                        });
                        
                        if (httpResponse.ok) {
                            backendStatusElement.textContent = 'Terhubung (HTTP)';
                            backendStatusElement.className = 'status-value status-connected';
                            updateConnectionStatus(true, 'Terhubung via HTTP (Fallback)');
                            return true;
                        }
                    } catch (httpError) {
                        console.error("Koneksi HTTP juga gagal:", httpError);
                    }
                }
                
                updateConnectionStatus(false, 'Tidak dapat terhubung ke server');
                return false;
            }
        }

        // Fungsi untuk mengambil konfigurasi dari server
        async function fetchConfig() {
            try {
                // Tentukan base URL API
                apiBaseUrl = determineApiBaseUrl();
                console.log("Mencoba mengakses API di:", apiBaseUrl);
                
                const response = await fetch(`${apiBaseUrl}/api/config`, {
                    signal: AbortSignal.timeout(10000) // Timeout setelah 10 detik
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const config = await response.json();
                
                if (config.firebaseDataUrl) {
                    firebaseDataUrl = config.firebaseDataUrl;
                    localStorage.setItem("firebaseUrl", firebaseDataUrl);
                }
                
                if (config.appName) {
                    appName = config.appName;
                    document.title = appName + " - Login";
                    document.getElementById('appName').textContent = appName;
                }
                
                console.log("Konfigurasi berhasil diambil dari server");
                updateConnectionStatus(true, 'Terhubung ke Server');
                return true;
            } catch (error) {
                console.warn("Gagal mengambil konfigurasi dari server:", error.message);
                // Fallback ke default jika gagal
                firebaseDataUrl = "https://steady-fin-368617-default-rtdb.firebaseio.com/AsiaPayment.json";
                localStorage.setItem("firebaseUrl", firebaseDataUrl);
                updateConnectionStatus(false, 'Menggunakan mode fallback');
                return false;
            }
        }

        // Fungsi untuk memvalidasi input nomor HP
        function validatePhoneNumber(phone) {
            // Hanya boleh berisi angka
            const phoneRegex = /^\d+$/;
            return phoneRegex.test(phone);
        }
        
        // Event listener untuk input nomor HP
        document.getElementById('nomorhp').addEventListener('input', function(e) {
            const input = e.target;
            const errorElement = document.getElementById('nomorhpError');
            
            if (!validatePhoneNumber(input.value)) {
                input.classList.add('error');
                errorElement.style.display = 'block';
            } else {
                input.classList.remove('error');
                errorElement.style.display = 'none';
            }
        });
        
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Periksa koneksi sebelum mengirim form
            if (!isOnline) {
                showError("Tidak terhubung ke server. Silakan coba lagi.", true);
                return;
            }
            
            // Ambil nilai dari form dan terapkan trim()
            let kode = document.getElementById('kode').value.trim().toUpperCase();
            let nomorhp = document.getElementById('nomorhp').value.trim();
            
            // Validasi nomor HP
            if (!validatePhoneNumber(nomorhp)) {
                showError("Nomor HP hanya boleh berisi angka");
                return;
            }
            
            // Normalisasi nomor HP (hapus karakter non-digit)
            nomorhp = nomorhp.replace(/\D/g, '');
            
            // Tampilkan loading popup
            showLoading();
            document.getElementById('result').style.display = 'none';
            
            try {
                let data;
                
                // Coba kirim request ke API InsertInbox yang sebenarnya
                try {
                    const response = await fetch(`${apiBaseUrl}/api/InsertInbox`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            pesan: "LISTNO",
                            kode_reseller: kode,
                            pengirim: nomorhp,
                            tipe_pengirim: "W"
                        }),
                        signal: AbortSignal.timeout(15000) // Timeout setelah 15 detik
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    data = await response.json();
                } catch (apiError) {
                    // Jika API tidak dapat diakses, gunakan simulasi untuk testing
                    console.warn("API InsertInbox tidak dapat diakses, menggunakan simulasi:", apiError.message);
                    
                    // Simulasi respons untuk testing
                    if (kode === "OWNER" && nomorhp === "082311640444") {
                        data = {
                            ok: true,
                            result: {
                                status: 0,
                                statusDesc: "Success",
                                pesan: "Daftar nomor: 082311640444, 08123456789, 085678901234"
                            }
                        };
                    } else {
                        data = {
                            ok: false,
                            result: {
                                status: 41,
                                statusDesc: "Bukan Reseller"
                            }
                        };
                    }
                }
                
                // Sembunyikan loading popup
                hideLoading();
                
                // Periksa jika kode reseller tidak valid
                if (data.result && (data.result.status === 41 || data.result.statusDesc === "Bukan Reseller")) {
                    showError("Kode reseller atau nomor HP tidak valid");
                    return;
                }
                
                if (data.ok) {
                    // Simpan data ke localStorage (pastikan huruf besar untuk kode reseller)
                    localStorage.setItem("kodereseller", kode.toUpperCase());
                    localStorage.setItem("nomorhp", nomorhp);
                    
                    showInfo("Login berhasil! Mengarahkan ke menu...");
                    
                    // Redirect setelah 2 detik
                    setTimeout(() => {
                        window.location.href = "menu_beranda.html?kodereseller=" + 
                                              encodeURIComponent(kode.toUpperCase()) + 
                                              "&nomorhp=" + 
                                              encodeURIComponent(nomorhp);
                    }, 2000);
                } else {
                    showError("Login gagal. Periksa kode reseller dan nomor HP Anda.");
                }
            } catch (error) {
                // Sembunyikan loading popup
                hideLoading();
                
                // Tampilkan error dengan opsi retry
                showError(`Gagal terhubung ke server. Pastikan Anda terhubung ke internet. Detail: ${error.message}`, true);
                console.error('Error:', error);
            }
        });
        
        // Inisialisasi aplikasi
        async function initializeApp() {
            showLoading();
            
            try {
                // Periksa koneksi server terlebih dahulu
                const isConnected = await checkServerConnection();
                
                if (isConnected) {
                    // Ambil konfigurasi dari server
                    await fetchConfig();
                } else {
                    showInfo("Tidak dapat terhubung ke server backend. Beberapa fitur mungkin terbatas. Anda masih dapat mencoba login dengan data default.");
                }
            } catch (error) {
                console.error("Gagal inisialisasi aplikasi:", error);
                showInfo("Tidak dapat terhubung ke server. Anda masih dapat mencoba login dengan data default.");
            } finally {
                hideLoading();
            }
        }
        
        // Jalankan inisialisasi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // Periksa koneksi secara berkala
            setInterval(checkServerConnection, 30000); // Setiap 30 detik
        });
    </script>
</body>
</html>
